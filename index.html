<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>幼稚園児向け 計算ドリル</title>
    <style>
        /* A4サイズに合わせた基本設定 */
        @page {
            size: A4;
            margin: 10mm; /* 印刷時の余白 */
        }
        body {
            font-family: 'Arial', 'sans-serif';
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 10mm; /* 全体のパディング */
            box-sizing: border-box;
            line-height: 1.3; /* 行の高さを詰める */
            color: #333; /* 標準的な文字色 */
            background-color: #ffffff; /* 白い背景 */
        }
        .container {
            width: 100%;
            max-width: 210mm; /* A4の幅 */
            padding: 2mm; /* 内側のパディングを削減 */
            text-align: center;
            background-color: #ffffff; /* 白い背景 */
            border-radius: 0; /* 角丸を削除 */
            box-shadow: none; /* 影を削除 */
        }
        h1 {
            font-size: 30pt;
            margin-top: 5px;
            margin-bottom: 8px;
            color: #333;
            text-shadow: none;
        }
        .problem-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px 30px;
            justify-content: center;
            width: 90%;
            margin: 0 auto;
        }
        .problem {
            font-size: 24pt;
            padding: 4px;
            border-bottom: 2px solid #ccc; /* 標準的なグレーの下線 */
            text-align: left;
            white-space: nowrap;
            color: #333;
        }
        .problem span {
            display: inline-block;
            min-width: 45px;
            text-align: right;
            color: #333;
        }
        .instructions {
            font-size: 14pt;
            margin-bottom: 10px;
            color: #555;
            font-weight: normal; /* 太字を削除 */
        }

        /* 選択ボタンのスタイル */
        .selection-group {
            margin-bottom: 8px;
            font-size: 16pt;
            color: #555;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
        }
        .selection-group button {
            padding: 5px 10px;
            font-size: 13pt;
            border: 1px solid #ccc; /* 標準的なボーダー */
            border-radius: 5px; /* 標準的な角丸 */
            background-color: #f0f0f0; /* 薄いグレーの背景 */
            color: #333;
            cursor: pointer;
            margin: 4px;
            box-shadow: none; /* 影を削除 */
            transition: none; /* アニメーションを削除 */
            text-shadow: none;
        }
        .selection-group button.active {
            background-color: #007bff; /* 標準的なアクティブ色 */
            color: white;
            border-color: #007bff;
            box-shadow: none;
            transform: none;
        }
        .selection-group button:hover:not(.active) {
            background-color: #e0e0e0; /* ホバー時の背景色 */
            transform: none;
        }

        .addend-selection {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
            font-size: 16pt;
            color: #555;
        }
        .addend-selection select {
            font-size: 15pt;
            padding: 3px 7px;
            border-radius: 5px; /* 標準的な角丸 */
            border: 1px solid #ccc; /* 標準的なボーダー */
            background-color: #f0f0f0;
            margin-left: 8px;
            margin-right: 8px;
            color: #333;
        }
        .refresh-button {
            padding: 5px 10px;
            font-size: 13pt;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f0f0f0;
            color: #333;
            cursor: pointer;
            box-shadow: none;
            transition: none;
            text-shadow: none;
        }
        .refresh-button:hover {
            background-color: #e0e0e0;
            transform: none;
        }

        .print-button {
            margin-top: 15px;
            padding: 10px 20px;
            font-size: 16pt;
            background-color: #007bff; /* 標準的なボタン色 */
            color: white;
            border: none;
            border-radius: 5px; /* 標準的な角丸 */
            cursor: pointer;
            box-shadow: none;
            transition: none;
            text-shadow: none;
            font-weight: bold;
        }
        .print-button:hover {
            background-color: #0056b3; /* ホバー時の色 */
            transform: none;
        }

        /* 印刷時に不要な要素を非表示にする設定 */
        @media print {
            body {
                background: none;
                color: black;
            }
            .selection-group,
            .addend-selection,
            .print-button,
            .refresh-button {
                display: none;
            }
            .container {
                box-shadow: none;
                border-radius: 0;
                padding: 0;
            }
            h1 {
                text-shadow: none;
                color: black;
            }
            .problem, .problem span, .instructions {
                color: black;
            }
            .problem {
                border-bottom: 2px solid black;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>計算ドリル</h1>
        <p class="instructions">
            かずをかぞえて、こたえをかこう！<br>
            ぜんぶ同じ数字を足すよ！
        </p>

        <!-- 演算選択 -->
        <div class="selection-group">
            <button id="addOperation" class="active">足し算</button>
            <button id="subtractOperation">引き算</button>
        </div>

        <!-- 難易度選択 -->
        <div class="selection-group">
            <button id="level1Button" class="active">レベル1</button>
            <button id="level2Button">レベル2</button>
            <button id="level3Button">レベル3</button>
        </div>

        <!-- 足す（引く）数字の選択と再出力ボタン -->
        <div class="addend-selection">
            <span id="addendSelectLabel">足す（引く）数字を選んでね:</span>
            <select id="selectAddend">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3" selected>3</option> <!-- デフォルトは+3 -->
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
            </select>
            <button id="refreshProblemsButton" class="refresh-button">再出力</button>
        </div>

        <!-- 問題を動的に生成するためのコンテナ -->
        <div id="problems-container" class="problem-grid">
            <!-- JavaScriptで問題がここに追加されます -->
        </div>

        <!-- 印刷ボタン -->
        <button class="print-button" onclick="window.print()">このドリルを印刷する</button>
    </div>

    <script>
        // Helper function to shuffle an array (Fisher-Yates algorithm)
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]]; // Swap elements
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const problemsContainer = document.getElementById('problems-container');
            const selectAddend = document.getElementById('selectAddend');
            const addOperationButton = document.getElementById('addOperation');
            const subtractOperationButton = document.getElementById('subtractOperation');
            const level1Button = document.getElementById('level1Button');
            const level2Button = document.getElementById('level2Button');
            const level3Button = document.getElementById('level3Button'); // New Level 3 button
            const refreshProblemsButton = document.getElementById('refreshProblemsButton'); // 再出力ボタン
            const instructionsText = document.querySelector('.instructions');
            const addendSelectContainer = document.querySelector('.addend-selection'); // 足す（引く）数字選択のコンテナ

            let currentOperation = 'add'; // 'add' or 'subtract'
            let currentDifficulty = 'level1'; // 'level1', 'level2', or 'level3' (default to level1)

            // Function to update active state of buttons
            function updateActiveButton(buttons, activeId) {
                buttons.forEach(btn => {
                    if (btn.id === activeId) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
            }

            // Function to update instructions based on operation
            function updateInstructions() {
                if (currentOperation === 'add') {
                    instructionsText.innerHTML = `かずをかぞえて、こたえをかこう！<br>ぜんぶ同じ数字を足すよ！`;
                } else {
                    instructionsText.innerHTML = `かずをかぞえて、こたえをかこう！<br>ぜんぶ同じ数字を引くよ！`;
                }
            }

            // Function to update visibility of addend select based on difficulty
            function updateAddendSelectVisibility() {
                if (currentDifficulty === 'level3') {
                    addendSelectContainer.style.display = 'none'; // Hide for Level 3
                } else {
                    addendSelectContainer.style.display = 'flex'; // Show for Level 1/2
                }
            }

            // 問題を生成する関数
            function generateProblems() {
                problemsContainer.innerHTML = ''; // Clear container
                const selectedOperand2 = parseInt(selectAddend.value); // Selected from dropdown (used for L1/L2)
                const operator = currentOperation === 'add' ? '+' : '-';
                const numberOfProblems = 20;

                let generatedProblems = []; // Stores {left, right, op} for final display
                let lastTwoLeftOperands = []; // To prevent immediate repetition of left operand

                // If Level 1 Addition, prepare the fixed pool [1,1,2,2,...,10,10]
                let level1AddFixedPool = [];
                if (currentDifficulty === 'level1' && currentOperation === 'add') {
                    for (let i = 1; i <= 10; i++) {
                        level1AddFixedPool.push(i);
                        level1AddFixedPool.push(i);
                    }
                    shuffleArray(level1AddFixedPool); // Shuffle this specific pool once
                }

                for (let k = 0; k < numberOfProblems; k++) {
                    let currentLeftOperand;
                    let currentRightOperand;

                    // Determine the right operand for the current problem
                    if (currentDifficulty === 'level3') {
                        currentRightOperand = Math.floor(Math.random() * 9) + 1; // Random 1-9 for Level 3
                    } else {
                        currentRightOperand = selectedOperand2; // Fixed from dropdown for L1/L2
                    }

                    // Build a temporary list of eligible left operands for *this specific pick*
                    let candidatesForThisPick = [];
                    if (currentDifficulty === 'level1' && currentOperation === 'add') {
                        // For Level 1 Addition, draw from the remaining fixed pool
                        candidatesForThisPick = [...level1AddFixedPool];
                    } else {
                        // For other modes, generate from the base range
                        let minBaseRange, maxBaseRange;
                        if (currentDifficulty === 'level1') { // This covers Level 1 Subtract
                            minBaseRange = 1;
                            maxBaseRange = 10;
                        } else { // Level 2 or Level 3
                            minBaseRange = 1;
                            maxBaseRange = 20;
                        }
                        for (let i = minBaseRange; i <= maxBaseRange; i++) {
                            candidatesForThisPick.push(i);
                        }
                    }

                    // Apply subtraction constraint: left operand must be >= right operand
                    let validNumbersForOperation = candidatesForThisPick.filter(num => {
                        if (currentOperation === 'subtract') {
                            return num >= currentRightOperand;
                        }
                        return true;
                    });

                    if (validNumbersForOperation.length === 0) {
                        // Display error if no valid numbers can be picked for subtraction
                        const noProblemDiv = document.createElement('div');
                        noProblemDiv.style.gridColumn = '1 / -1'; // Span across all columns
                        noProblemDiv.style.textAlign = 'center';
                        noProblemDiv.style.fontSize = '18pt';
                        noProblemDiv.style.padding = '20px';
                        noProblemDiv.style.color = '#ff0000';
                        noProblemDiv.innerHTML = `この設定では問題を作成できません。引く数字を小さくしてください。`;
                        problemsContainer.appendChild(noProblemDiv);
                        return; // Stop problem generation
                    }

                    // Apply "no same number in last two" constraint for the left operand
                    let finalCandidatesForPick = validNumbersForOperation.filter(num => !lastTwoLeftOperands.includes(num));

                    if (finalCandidatesForPick.length > 0) {
                        currentLeftOperand = finalCandidatesForPick[Math.floor(Math.random() * finalCandidatesForPick.length)];
                    } else {
                        // Fallback: If avoiding last two is impossible (e.g., small pool), pick any valid number
                        currentLeftOperand = validNumbersForOperation[Math.floor(Math.random() * validNumbersForOperation.length)];
                    }

                    generatedProblems.push({
                        left: currentLeftOperand,
                        right: currentRightOperand,
                        op: operator
                    });

                    // For Level 1 Addition, remove the chosen number from its unique pool
                    if (currentDifficulty === 'level1' && currentOperation === 'add') {
                         const indexInPool = level1AddFixedPool.indexOf(currentLeftOperand);
                         if (indexInPool > -1) {
                             level1AddFixedPool.splice(indexInPool, 1);
                         }
                    }

                    // Update lastTwoLeftOperands
                    lastTwoLeftOperands.push(currentLeftOperand);
                    if (lastTwoLeftOperands.length > 2) {
                        lastTwoLeftOperands.shift();
                    }
                } // End of for loop for generating 20 problems

                // Display the generated problems
                generatedProblems.forEach(problem => {
                    const problemDiv = document.createElement('div');
                    problemDiv.classList.add('problem');
                    problemDiv.innerHTML = `<span>${problem.left}</span> ${problem.op} ${problem.right} = _______`;
                    problemsContainer.appendChild(problemDiv);
                });
            }

            // Event Listeners for operation buttons
            addOperationButton.addEventListener('click', () => {
                currentOperation = 'add';
                updateActiveButton([addOperationButton, subtractOperationButton], 'addOperation');
                updateInstructions();
                generateProblems();
            });

            subtractOperationButton.addEventListener('click', () => {
                currentOperation = 'subtract';
                updateActiveButton([addOperationButton, subtractOperationButton], 'subtractOperation');
                updateInstructions();
                generateProblems();
            });

            // Event Listeners for difficulty buttons
            level1Button.addEventListener('click', () => {
                currentDifficulty = 'level1';
                updateActiveButton([level1Button, level2Button, level3Button], 'level1Button');
                updateAddendSelectVisibility(); // Update visibility
                generateProblems();
            });

            level2Button.addEventListener('click', () => {
                currentDifficulty = 'level2';
                updateActiveButton([level1Button, level2Button, level3Button], 'level2Button');
                updateAddendSelectVisibility(); // Update visibility
                generateProblems();
            });

            level3Button.addEventListener('click', () => { // New Level 3 button
                currentDifficulty = 'level3';
                updateActiveButton([level1Button, level2Button, level3Button], 'level3Button');
                updateAddendSelectVisibility(); // Update visibility
                generateProblems();
            });

            // Event Listener for the addend selection
            selectAddend.addEventListener('change', generateProblems);

            // Event Listener for the refresh button
            refreshProblemsButton.addEventListener('click', generateProblems);

            // Initial calls on DOMContentLoaded
            updateActiveButton([level1Button, level2Button, level3Button], 'level1Button'); // デフォルトはレベル1をアクティブに
            updateAddendSelectVisibility(); // Initial visibility
            generateProblems();
            updateInstructions();
        });
    </script>
</body>
</html>
